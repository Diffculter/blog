<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【小哥哥, 跨域要不要了解下】NGINX 反向代理 | KrialY</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/blog/img/witch.ico">
    <meta name="description" content="KrialY">
    <link rel="preload" href="/blog/assets/css/0.styles.9bd91c97.css" as="style"><link rel="preload" href="/blog/assets/js/app.34681b4e.js" as="script"><link rel="preload" href="/blog/assets/js/2.3b0a5b51.js" as="script"><link rel="preload" href="/blog/assets/js/9.2b1b09fe.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f6814326.js"><link rel="prefetch" href="/blog/assets/js/11.13a286eb.js"><link rel="prefetch" href="/blog/assets/js/12.5bf77b1c.js"><link rel="prefetch" href="/blog/assets/js/13.3c360f02.js"><link rel="prefetch" href="/blog/assets/js/14.e8a1ddea.js"><link rel="prefetch" href="/blog/assets/js/15.d3fa364f.js"><link rel="prefetch" href="/blog/assets/js/16.d410f76e.js"><link rel="prefetch" href="/blog/assets/js/17.a6626fab.js"><link rel="prefetch" href="/blog/assets/js/18.628ad834.js"><link rel="prefetch" href="/blog/assets/js/19.f2d1bf74.js"><link rel="prefetch" href="/blog/assets/js/20.09063965.js"><link rel="prefetch" href="/blog/assets/js/21.11688d76.js"><link rel="prefetch" href="/blog/assets/js/22.66b05294.js"><link rel="prefetch" href="/blog/assets/js/23.fc11a55f.js"><link rel="prefetch" href="/blog/assets/js/24.1f45c701.js"><link rel="prefetch" href="/blog/assets/js/25.a11b9ec5.js"><link rel="prefetch" href="/blog/assets/js/26.0decdb5c.js"><link rel="prefetch" href="/blog/assets/js/3.db7620e6.js"><link rel="prefetch" href="/blog/assets/js/4.1f285f65.js"><link rel="prefetch" href="/blog/assets/js/5.a8ad7dfb.js"><link rel="prefetch" href="/blog/assets/js/6.a4410cb8.js"><link rel="prefetch" href="/blog/assets/js/7.31dfa360.js"><link rel="prefetch" href="/blog/assets/js/8.02257648.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9bd91c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">KrialY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于作者" class="dropdown-title"><span class="title">关于作者</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/KrialY" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mubu.com/doc/explore/34397" target="_blank" rel="noopener noreferrer" class="nav-link external">
  幕布
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于作者" class="dropdown-title"><span class="title">关于作者</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/KrialY" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://mubu.com/doc/explore/34397" target="_blank" rel="noopener noreferrer" class="nav-link external">
  幕布
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Git命令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/PAGE/2019-10-23-git-contribution/" class="sidebar-link">GitHub&quot;小绿格&quot;不增加</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-23-git-contribution/#寻找原因🎉" class="sidebar-link">寻找原因🎉</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-23-git-contribution/#大功告成💧" class="sidebar-link">大功告成💧</a></li></ul></li><li><a href="/blog/PAGE/2019-11-20-git-emoji/" class="sidebar-link">GitHub-Emoji表情合集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-11-20-git-emoji/#人物😊" class="sidebar-link">人物😊</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-11-20-git-emoji/#自然❄️" class="sidebar-link">自然❄️</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-11-20-git-emoji/#物品🎍" class="sidebar-link">物品🎍</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-11-20-git-emoji/#建筑🏡" class="sidebar-link">建筑🏡</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-11-20-git-emoji/#标志🉑" class="sidebar-link">标志🉑</a></li></ul></li></ul></section></li><li><a href="/blog/PAGE/2019-10-25-build-blog/" class="sidebar-link">搭建一个Vue风格的博客</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#前言📕" class="sidebar-link">前言📕</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#自己的博客😄" class="sidebar-link">自己的博客😄</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#开始搭建👻" class="sidebar-link">开始搭建👻</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#基本配置🏄‍" class="sidebar-link">基本配置🏄‍</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#导航栏配置👙" class="sidebar-link">导航栏配置👙</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#侧边栏配置⛳" class="sidebar-link">侧边栏配置⛳</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#配置首页🎁" class="sidebar-link">配置首页🎁</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#部署🎉" class="sidebar-link">部署🎉</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-10-25-build-blog/#更多🧀" class="sidebar-link">更多🧀</a></li></ul></li><li><a href="/blog/PAGE/2019-12-04-nginx-1/" aria-current="page" class="active sidebar-link">【小哥哥, 跨域要不要了解下】NGINX 反向代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#代理是个啥" class="sidebar-link">代理是个啥</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#修改-hosts-完成域名绑定" class="sidebar-link">修改 hosts 完成域名绑定</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#安装-nginx" class="sidebar-link">安装 nginx</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#nginx-配置初探" class="sidebar-link">nginx 配置初探</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#创建跨域环境" class="sidebar-link">创建跨域环境</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#完善-nginx-配置" class="sidebar-link">完善 nginx 配置</a></li><li class="sidebar-sub-header"><a href="/blog/PAGE/2019-12-04-nginx-1/#总结" class="sidebar-link">总结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="【小哥哥-跨域要不要了解下】nginx-反向代理"><a href="#【小哥哥-跨域要不要了解下】nginx-反向代理" class="header-anchor">#</a> 【小哥哥, 跨域要不要了解下】NGINX 反向代理</h3> <blockquote><p>转自掘金大佬 <a href="https://juejin.im/post/5c0e6d606fb9a049f66bf246" target="_blank" rel="noopener noreferrer">传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <blockquote><p>原本本系列文章是不打算详写 NGINX 反向代理的. 至于为什么不想写呢? 当然是因为我不太会咯~~</p></blockquote> <p><img src="http://www.almx.top/image/blog/nginx-1.jpg" alt="nginx-1.jpg"></p> <blockquote><p>但是, 不久前有大佬点了这道菜, 那当然就得上啦 😄</p></blockquote> <h2 id="代理是个啥"><a href="#代理是个啥" class="header-anchor">#</a> 代理是个啥</h2> <p>既然要聊反向代理, 那首先得知道代理是个啥吧? 嗯.</p> <p><img src="http://www.almx.top/image/blog/nginx-2.jpg" alt="nginx-2.jpg"></p> <h3 id="正向代理"><a href="#正向代理" class="header-anchor">#</a> 正向代理</h3> <p>比如, 你买束花, 想要给隔壁工位的测试妹子小丽表白. 但是又怕被人家直面拒绝太没面子. 于是你把鲜花委托给平时和小丽一起的测试小伙伴小红. 让她帮忙把花送给小丽. 这就是一个简单的代理过程, 小红作为代理帮你把花送给了小丽, 当然这种情况在现实中并不推荐使用, 因为难以避免中间商赚差价 😂.</p> <p>在上面的例子中, 你作为客户端(请求方), 想要向服务方(小丽)发起请求. 但是碍于面子你主动找到了第三方(小红)作为代理向服务方发送请求, 这种情况就是常说的正向代理. 正向代理在互联网中的使用主要是科学上网, 你想访问谷歌但是碍于防火墙你只能通过vpn服务器作为代理才能访问. 这个时候一般也要找值得信赖的vpn厂商, 避免中间商赚差价 😄.</p> <p><img src="http://www.almx.top/image/blog/nginx-3.jpg" alt="nginx-3.jpg"></p> <h3 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h3> <p>关于反向代理的例子, 那就比较多啦. 比如, 孤独的你躺在床上夜不能寐. 于是乎, 拿出手机, 点亮了屏幕, 拨通 <code>10086</code>, 中国移动就会随机分配一个当前处于空闲的客服MM, 你可以和客服MM聊聊天, 问问她家住哪里, 有没有男朋友, 她的微信号, 她的手机号, 星座, 八字.......</p> <p>在这个例子中, 中国移动就充当了反向代理的角色. 你只需要拨打 <code>10086</code>. 至于会不会分配到 MM 会分配到哪个 MM 在接通之前你都是不知道的. 反向代理在互联网中的使用主要是实现负载均衡. 当你访问某个网站的时候, 反向代理服务器会从当前网站的所有服务器中选择一个空闲的服务器为你响应. 用于均衡每台服务器的负载率.</p> <h2 id="修改-hosts-完成域名绑定"><a href="#修改-hosts-完成域名绑定" class="header-anchor">#</a> 修改 hosts 完成域名绑定</h2> <p>mac 用户直接执行 <code>vim /private/etc/hosts</code> 在 <code>hosts</code> 文件最后添加一行:</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> a<span class="token punctuation">.</span>com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这一句是什么意思呢? 就是告诉我们的电脑访问 <code>a.com</code> 的时候, 无需请求 <code>DNS</code>, 直接指向我们本机.</p> <p>ps: <code>win</code> 环境下, <code>hosts</code> 文件在 <code>C:\Windows\System32\drivers\etc</code> 文件夹下. 如果没有权限修改, 把 <code>hosts</code> 文件先拷贝到别的位置, 通过编辑器打开并添加最后一行内容以后再剪切到原来的位置替换即可.</p> <p>验证: 打开命令行窗口执行 <code>ping a.com</code>, 如果访问的 <code>ip 为 127.0.0.1</code> 说明我们的域名绑定就完成啦 ^_^</p> <p><img src="http://www.almx.top/image/blog/nginx-4.gif" alt="nginx-4.gif"></p> <h2 id="安装-nginx"><a href="#安装-nginx" class="header-anchor">#</a> 安装 nginx</h2> <blockquote><p>要做 <code>NGINX</code> 反向代理, 肯定要安装 <a href="http://nginx.org/" target="_blank" rel="noopener noreferrer">nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 本文安装步骤示例环境为 mac, win 的小伙伴, 可以百度一下嗷, 这个东西大同小异.</p></blockquote> <ul><li>安装 <code>brew</code> 命令, 执行 <code>ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</code></li> <li>安装 <code>nginx</code>, 执行 <code>brew install nginx</code></li> <li>启动 <code>nginx nginx</code>, 如果报没有权限, 执行 <code>sudo nginx</code></li></ul> <p><code>nginx</code> 启动后, 浏览器打开 <a href="localhost:8080">localhost:8080</a>, 即可验证. 出现以下界面说明安装成功.</p> <p><img src="http://www.almx.top/image/blog/nginx-5.jpg" alt="nginx-5.jpg"></p> <h2 id="nginx-配置初探"><a href="#nginx-配置初探" class="header-anchor">#</a> nginx 配置初探</h2> <p>配置完 <code>hosts</code> 域名已经能够成功绑定. 现在如果我们访问 <code>a.com</code> 实际上是会访问到我们的自己的电脑辣. 那还不抓紧试一下?</p> <p>浏览器访问 <a href="a.com">a.com</a></p> <p><img src="http://www.almx.top/image/blog/nginx-6.jpg" alt="nginx-6.jpg"></p> <p>这是什么鬼????</p> <p><img src="http://www.almx.top/image/blog/nginx-7.jpg" alt="nginx-7.jpg"></p> <p>为什么会 无法访问此网站 呢? 我们下载安装完 <code>nginx</code> 还没有做任何配置. 接下来, 我们稍微配置一下就 OK:</p> <ul><li>命令行切换到 <code>nginx</code> 配置目录下 <code>cd /usr/local/etc/nginx/servers</code></li> <li>创建并编辑配置文件 <code>vim test.conf</code>, 在配置文件中粘贴以下内容</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    <span class="token comment"># 监听80端口号</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment"># 监听访问的域名</span>
    server_name a.com<span class="token punctuation">;</span>

    <span class="token comment"># 根据访问路径配置</span>
    location / <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 https://www.baidu.com</span>
        proxy_pass https://www.baidu.com<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>保存文件, 并执行 <code>nginx -s reload</code> 重启 <code>nginx</code>.</li> <li>回到浏览器, 打开 <a href="a.com">a.com</a> 的页签, 强制刷新.</li></ul> <p><img src="http://www.almx.top/image/blog/nginx-8.jpg" alt="nginx-8.jpg"></p> <p>恭喜你已经完成了第一个 <code>nginx</code> 配置.</p> <p><img src="http://www.almx.top/image/blog/nginx-9.gif" alt="nginx-9.gif"></p> <h2 id="创建跨域环境"><a href="#创建跨域环境" class="header-anchor">#</a> 创建跨域环境</h2> <blockquote><p>通过一系列的折腾, 我们已经可以通过 <code>nginx</code> 将<code>a.com</code> 转发到百度. 完成了第一步, 接下来我们创建跨域的 <code>Case</code> 并一步一步通过 <code>nginx</code> 配置实现跨域.</p></blockquote> <p>首先, 项目前后端添加 <code>nginx</code> 目录, 用户存放前后端代码. 代码结构如下图所示.</p> <p><img src="http://www.almx.top/image/blog/nginx-10.jpg" alt="nginx-10.jpg"></p> <p>其次编写前后端代码:</p> <p>前端代码<code>(./fe/nginx/index.html)</code>:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>CORS 实现跨域<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>CORS 实现跨域<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8888/api/getFriend'</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token string">'quanquanbunengshuo'</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>编写完前端代码以后, 启动前端 <code>web</code> 容器. <code>live-server ./fe/nginx</code></p> <p><img src="http://www.almx.top/image/blog/nginx-11.jpg" alt="nginx-11.jpg"></p> <p>命令行中出现了黄色警告, 通知我们 <code>8080</code> 端口已经被占用, 这又是为什么呢? 大家请思考一哈.</p> <p><img src="http://www.almx.top/image/blog/nginx-12.jpg" alt="nginx-12.jpg"></p> <p>我们重新指定一个端口<code>live-server ./fe/nginx --port=9999</code> 哈哈, 换一个指令, 依旧是那么顺畅. ^_^</p> <p>后端代码:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个 http 服务</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;{name: 'quanquan', friend: 'guiling'}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动服务, 监听端口</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务启动成功, 正在监听: '</span><span class="token punctuation">,</span> <span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>启动后端服务 <code>node ./be/nginx/index.js</code></p> <h2 id="完善-nginx-配置"><a href="#完善-nginx-配置" class="header-anchor">#</a> 完善 nginx 配置</h2> <blockquote><p>前后端代码已经准备完成, 这一步我们就来点干货. 完成最后的配置.</p></blockquote> <ul><li>首先, 修改 <code>nginx</code> 配置, 把百度地址替换成本地的前端地址</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    <span class="token comment"># 监听80端口号</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment"># 监听访问的域名</span>
    server_name a.com<span class="token punctuation">;</span>

    <span class="token comment"># 根据访问路径配置</span>
    location / <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 http://127.0.0.1:9999</span>
        proxy_pass http://127.0.0.1:9999<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>修改完成 · 配置文件以后, 切记执行 <code>nginx -s -reload</code> 重启 <code>nginx</code>.</li> <li>访问<a href="a.com">a.com</a></li></ul> <p><img src="http://www.almx.top/image/blog/nginx-13.jpg" alt="nginx-13.jpg"></p> <p>熟悉的报错又出现了...</p> <ul><li>修改前端项目中的接口地址</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 接口地址修改为当前域名下 /api 路劲下的 getFriend</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/api/getFriend'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>修改 <code>nginx</code> 配置文件</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token comment"># 监听80端口号</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment"># 监听访问的域名</span>
    <span class="token keyword">server_name</span> a<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

    <span class="token comment"># 根据访问路径配置</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 http://127.0.0.1:9999</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9999</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 监听根目录下的 /api 路径</span>
    <span class="token keyword">location</span> <span class="token operator">/</span>api<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 http://127.0.0.1:8888</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>新加的对于 <code>api</code> 路径的监听的意思就是把关于后端 <code>api</code> 的请求转发到后端项目上(哈哈, 当然这就是为啥好多后端接口都是要有 · 开头的啦). 重启 <code>nginx</code> 以后, 再次刷新浏览器, 后端返回的结果已经成功的打印到了控制台, 本次跨域访问任务完成.</p> <p><img src="http://www.almx.top/image/blog/nginx-14.jpg" alt="nginx-14.jpg"></p> <p>细心的小伙伴肯定发现了, 控制台还有一个报错. 这个是因为我们的项目中用到了 <code>live-server</code> 这个工具需要 <code>websocket</code> 导致的. 我们可以通过添加以下配置解决.</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="http://www.almx.top/image/blog/nginx-15.jpg" alt="nginx-15.jpg"></p> <p>报错消失 😄, 此时完整的 <code>nginx</code> 配置文件为</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token comment"># 监听80端口号</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment"># 监听访问的域名</span>
    <span class="token keyword">server_name</span> a<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

    <span class="token comment"># 根据访问路径配置</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 http://127.0.0.1:9999</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9999</span><span class="token punctuation">;</span>

        <span class="token comment"># 兼容websocket</span>
        <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 监听根目录下的 /api 路径</span>
    <span class="token keyword">location</span> <span class="token operator">/</span>api<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># 把请求转发到 http://127.0.0.1:8888</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>前后端代码地址为: <a href="https://github.com/luoquanquan/cross-domain/commit/f38f56689fdac1526244ecadaa979a52c9c4a7ea" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>至此, 我们已经通过 nginx 反向代理的方式实现了跨域访问 <code>api</code>, 对于跨域的解释为: 跨域源于同源策略, 是浏览器保证用户安全的行为. 我们使用的 <code>nginx</code> 反向代理实际上是对浏览器的一种 &quot;哄骗&quot;, 让它认为自己访问到的是同域的 api. 实际上是在服务端做了个调包, 这个道理就如同你拨打 <code>10086</code> 你就认定了给你分配到的一定是<code>中国移动的客服MM</code>(客服GG也是有可能出现的 😄)而<code>中国移动的客服MM</code>就是一个很安全的聊天对象, 没有必要再进行限制...</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/PAGE/2019-10-25-build-blog/" class="prev">
        搭建一个Vue风格的博客
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.34681b4e.js" defer></script><script src="/blog/assets/js/2.3b0a5b51.js" defer></script><script src="/blog/assets/js/9.2b1b09fe.js" defer></script>
  </body>
</html>
